name: Unified Smart Scheduler

on:
  repository_dispatch:
    types: [run-weather-tasks]
  
  workflow_dispatch:
    inputs:
      task:
        description: 'Manually run a single task (e.g., update_radar)'
        required: false

jobs:
  run-tasks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env
        with:
          gcp-sa-key: ${{ secrets.GCP_SA_KEY_BASE64 }}
          cwa-api-key: ${{ secrets.CWA_API_KEY }}
          ncdr-api-key: ${{ secrets.NCDR_API_KEY }}
          monev-api-key: ${{ secrets.MONEV_API_KEY }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          telegram-bot-token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          telegram-chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}
          r2-bucket-name: ${{ vars.R2_BUCKET_NAME }}
          r2-endpoint-url: ${{ vars.R2_ENDPOINT_URL }}

      - name: Smart Task Execution
        id: smart_tasks
        run: |
          # --- è™•ç†æ‰‹å‹•æˆ– API è§¸ç™¼çš„å–®ä¸€ä»»å‹™ ---
          TASK_TO_RUN="${{ github.event.client_payload.task || inputs.task }}"
          if [[ -n "$TASK_TO_RUN" ]]; then
            echo "ğŸ¯ Executing single task from external trigger: $TASK_TO_RUN"
            python functions/main.py "$TASK_TO_RUN"
            exit 0
          fi

          # --- è™•ç† App Script çš„è§¸ç™¼ ---
          echo "ğŸ¤– Running in scheduled mode..."
          # ä½¿ç”¨ TZ='Asia/Taipei' ä¾†ç²å–å°ç£æ™‚é–“ (UTC+8)
          hour=$(TZ='Asia/Taipei' date +%H)
          minute=$(TZ='Asia/Taipei' date +%M)
          echo "Current Taiwan Time (UTC+8): $hour:$minute"

          tasks_to_run=()

          # 1: Every 10 minutes 
          tasks_to_run+=("update_radar")

          # 2: Every hour (triggered between 5-14 minutes past the hour)
          if (( minute >= 5 && minute < 15 )); then
            tasks_to_run+=("update_air_quality")
            tasks_to_run+=("update_uv_index")
          fi

          # 3: Every 2 hours
          if (( hour % 2 == 0 && minute >= 5 && minute < 15 )); then
            tasks_to_run+=("update_current_weather")
          fi

          # 4: Every 3 hours
          if (( hour % 3 == 0 && minute >= 5 && minute < 15 )); then
            tasks_to_run+=("update_three_hour_forecast")
          fi

          # 4: Every 12 hours 
          if (( (hour == 6 || hour == 18) && minute >= 5 && minute < 15 )); then
            tasks_to_run+=("update_weekly_forecast")
          fi

          # 5: Daily at 00:05 (UTC+8)
          if (( hour == 0 && minute >= 5 && minute < 15 )); then
            tasks_to_run+=("update_sunrise_sunset")
          fi

          # 6: Typhoon forecast, triggered twice daily (UTC+8 at 03:05 and 15:05)
          if (( (hour == 3 || hour == 15) && minute >= 5 && minute < 15 )); then
            tasks_to_run+=("update_typhoon_forecast")
          fi

          # --- å¹³è¡ŒåŸ·è¡Œæ‰€æœ‰è¢«è§¸ç™¼çš„ä»»å‹™ ---
          # ä½¿ç”¨ sort -u ä¾†ç§»é™¤é‡è¤‡çš„ä»»å‹™
          unique_tasks=($(echo "${tasks_to_run[@]}" | tr ' ' '\n' | sort -u | tr '\n' ' '))

          if [ ${#unique_tasks[@]} -eq 0 ]; then
            echo "âœ… No tasks to run at this time."
            exit 0
          fi

          echo "ğŸš€ Starting parallel execution for: ${unique_tasks[*]}"
          for task in "${unique_tasks[@]}"; do
            echo "  -> Launching $task in background..."
            python functions/main.py "$task" &
          done

          # ç­‰å¾…æ‰€æœ‰èƒŒæ™¯ä»»å‹™å®Œæˆ
          wait
          echo "âœ… All tasks finished."