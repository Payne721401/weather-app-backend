name: Unified Smart Scheduler

on:
  repository_dispatch:
    types: [run-weather-tasks]
  
  workflow_dispatch:
    inputs:
      task:
        description: 'Manually run a single task (e.g., update_radar)'
        required: false

jobs:
  run-tasks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env
        with:
          gcp-sa-key: ${{ secrets.GCP_SA_KEY_BASE64 }}
          cwa-api-key: ${{ secrets.CWA_API_KEY }}
          ncdr-api-key: ${{ secrets.NCDR_API_KEY }}
          monev-api-key: ${{ secrets.MONEV_API_KEY }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          telegram-bot-token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          telegram-chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}
          r2-bucket-name: ${{ vars.R2_BUCKET_NAME }}
          r2-endpoint-url: ${{ vars.R2_ENDPOINT_URL }}

      - name: Smart Task Execution
        id: smart_tasks
        run: |
          # --- è™•ç†æ‰‹å‹•æˆ– API è§¸ç™¼çš„å–®ä¸€ä»»å‹™ ---
          TASK_TO_RUN="${{ github.event.client_payload.task || inputs.task }}"
          if [[ -n "$TASK_TO_RUN" ]]; then
            echo "ğŸ¯ Executing single task from external trigger: $TASK_TO_RUN"
            python functions/main.py "$TASK_TO_RUN"
            exit 0
          fi

          # --- è™•ç†ç”± App Script è§¸ç™¼çš„æ™ºèƒ½èª¿åº¦ ---
          echo "ğŸ¤– Running in scheduled mode..."
          # ä½¿ç”¨ TZ='Asia/Taipei' ä¾†ç²å–å°ç£æ™‚é–“ (UTC+8)
          hour=$(TZ='Asia/Taipei' date +%H)
          minute=$(TZ='Asia/Taipei' date +%M)
          echo "Current Taiwan Time (UTC+8): $hour:$minute"

          tasks_to_run=()

          # åˆ¤æ–·å¼ 1: æ¯10åˆ†é˜ (å› ç‚º App Script æ¯10åˆ†é˜è§¸ç™¼ä¸€æ¬¡ï¼Œæ‰€ä»¥é€™å€‹æ°¸é åŸ·è¡Œ)
          tasks_to_run+=("update_radar")

          # åˆ¤æ–·å¼ 2: æ¯å°æ™‚ (åœ¨æ•´é»å¾Œ 5-14 åˆ†é˜ä¹‹é–“è§¸ç™¼æ™‚åŸ·è¡Œ)
          if (( minute >= 5 && minute < 15 )); then
            tasks_to_run+=("update_air_quality")
            tasks_to_run+=("update_uv_index")
            tasks_to_run+=("update_current_weather")
          fi

          # åˆ¤æ–·å¼ 3: æ¯3å°æ™‚ (0,3,6...é»å¾Œçš„ 5-14 åˆ†é˜ä¹‹é–“è§¸ç™¼)
          if (( hour % 3 == 0 && minute >= 5 && minute < 15 )); then
            tasks_to_run+=("update_three_hour_forecast")
          fi

          # åˆ¤æ–·å¼ 4: æ¯å¤©å…©æ¬¡ (å°ç£æ™‚é–“ 06:05 å’Œ 18:05 è§¸ç™¼)
          if (( (hour == 6 || hour == 18) && minute >= 5 && minute < 15 )); then
            tasks_to_run+=("update_weekly_forecast")
          fi

          # åˆ¤æ–·å¼ 5: æ¯å¤©ä¸€æ¬¡ (å°ç£æ™‚é–“ 00:05 è§¸ç™¼)
          if (( hour == 0 && minute >= 5 && minute < 15 )); then
            tasks_to_run+=("update_sunrise_sunset")
          fi
          
          # åˆ¤æ–·å¼ 6: é¢±é¢¨é å ±ï¼Œæ¯å¤©å…©æ¬¡ (å°ç£æ™‚é–“ 02:40 å’Œ 14:40 è§¸ç™¼)
          if (( (hour == 2 || hour == 14) && minute >= 40 && minute < 50 )); then
            tasks_to_run+=("update_typhoon_forecast")
          fi

          # --- å¹³è¡ŒåŸ·è¡Œæ‰€æœ‰è¢«è§¸ç™¼çš„ä»»å‹™ ---
          # ä½¿ç”¨ sort -u ä¾†ç§»é™¤é‡è¤‡çš„ä»»å‹™
          unique_tasks=($(echo "${tasks_to_run[@]}" | tr ' ' '\n' | sort -u | tr '\n' ' '))

          if [ ${#unique_tasks[@]} -eq 0 ]; then
            echo "âœ… No tasks to run at this time."
            exit 0
          fi

          echo "ğŸš€ Starting parallel execution for: ${unique_tasks[*]}"
          for task in "${unique_tasks[@]}"; do
            echo "  -> Launching $task in background..."
            python functions/main.py "$task" &
          done

          # ç­‰å¾…æ‰€æœ‰èƒŒæ™¯ä»»å‹™å®Œæˆ
          wait
          echo "âœ… All tasks finished."